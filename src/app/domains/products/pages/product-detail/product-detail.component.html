@if (product(); as product) {
  <div class="grid grid-cols-1 md:grid-cols-2 md:gap-12">
    <!-- Columna Izquierda: Galer√≠a de Im√°genes -->
    <div class="flex flex-col">
      <!-- Contenedor de Imagen Principal -->
      <div
        #mainGalleryContainer
        class="relative w-full aspect-square border rounded-lg overflow-hidden bg-gray-100 touch-pan-y cursor-zoom-in"
        (click)="openLightbox()">

        <img
          alt="{{ product.title }}"
          class="w-full h-full object-cover transition-opacity duration-300 select-none"
          [src]="cover()"
          draggable="false"
        />

        @if (product.images.length > 1) {
          <button (click)="prevImage();$event.stopPropagation()" class="absolute top-1/2 left-2 -translate-y-1/2 bg-white/70 rounded-full p-2 hover:bg-white shadow-md z-10">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path d="M15.75 19.5L8.25 12l7.5-7.5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
          </button>
          <button (click)="nextImage();$event.stopPropagation()" class="absolute top-1/2 right-2 -translate-y-1/2 bg-white/70 rounded-full p-2 hover:bg-white shadow-md z-10">
            <svg class="w-6 h-6" viewBox="0 0 24 24"><path d="M8.25 4.5l7.5 7.5-7.5 7.5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
          </button>
        }
      </div>

      <!-- Contenedor de Miniaturas -->
      <div class="grid grid-cols-5 gap-2 mt-4">
        @for (img of product.images; track img; let i = $index) {
          <div
            class="aspect-square border-2 rounded-md cursor-pointer overflow-hidden transition-colors"
            (click)="changeCover(img, i)"
            [class.border-red-500]="i === currentIndex()"
            [class.border-transparent]="i !== currentIndex()">
            <img
              alt="Miniatura {{ i + 1 }}"
              class="w-full h-full object-cover"
              [src]="img"
            />
          </div>
        }
      </div>
    </div>

    <!-- Columna Derecha: Detalles del Producto -->
    <div class="mt-6 md:mt-0">
      <div class="linea-whatsapp mb-4">
        <button
          (click)="shareOnWhatsApp()"
          title="Compartir en WhatsApp"
          class="bg-green-500 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-green-600 transition-colors shadow-sm">
          <svg class="w-7 h-7" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.457l-6.354 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.149-.172.198-.296.297-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
        </button>
        <p class="leading-relaxed mt-2 text-sm text-gray-600">üëà Compartir Imagen del Producto con un Amigo</p>
      </div>

      <h3 class="text-gray-900 text-lg title-font font-normal mb-1">Contactar al Vendedor: <a href="tel:04249028378" class="text-blue-600 hover:underline">04249028378</a></h3>
      <h2 class="text-sm title-font text-gray-500 tracking-widest">{{ product.category?.name | uppercase }}</h2>
      <h1 class="text-gray-900 text-3xl title-font font-medium mb-1">{{ product.title }}</h1>
      <p class="text-black-950 text-sm font-thin mb-1">Sku: {{ product.sku }}</p>

      <p class="title-font font-medium text-3xl text-gray-900 mt-5 flex items-center">
        <img
          src="/assets/bcv1.jpg"
          alt="Logo BCV"
          class="h-16 w-auto ml-3 mr-3 object-contain"
        >
        Precio a Tasa BCV

        <span class="ml-3 font-bold text-blue-600">
          {{ product.price | calculoPrecio }}
        </span>
      </p>

      <h3 class="text-gray-900 text-lg title-font font-medium mb-4">Disponible: {{ product.stock }}</h3>

      <div class="flex items-center mt-6 space-x-4">
        <button
          (click)="addToCart()"
          class="flex text-white bg-red-500 border-0 py-3 px-8 focus:outline-none hover:bg-red-600 rounded text-lg active:bg-red-700 transition-colors">
          Agregar al Carrito
        </button>
      </div>

      <p class="leading-relaxed mt-6 text-gray-700 whitespace-pre-line">{{ product.description }}</p>
    </div>
  </div>

  <!-- LIGHTBOX CON ZOOM -->
  @if (lightboxVisible()) {
    <div (click)="closeLightbox()" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 transition-opacity">
      <div
        #lightboxContainer
        (click)="$event.stopPropagation()"
        class="relative touch-pan-y w-full h-full flex items-center justify-center">

        <img
          [src]="cover()"
          alt="{{ product.title }}"
          class="block max-w-[95vw] max-h-[90vh] object-contain select-none will-change-transform"
          [style.transform]="transformStyle()"
          draggable="false"
        >

        <!-- Bot√≥n de Cierre (X) -->
        <button (click)="closeLightbox()" class="absolute top-4 right-4 bg-white/10 text-white hover:bg-white/30 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold backdrop-blur-sm z-50">
          &times;
        </button>

        <!-- Navegaci√≥n con Flechas Lightbox -->
        @if (product.images.length > 1) {
          <button (click)="prevImage();$event.stopPropagation()" class="absolute top-1/2 left-2 md:left-4 -translate-y-1/2 bg-white/10 hover:bg-white/30 text-white rounded-full p-3 backdrop-blur-sm z-50">
            <svg class="w-8 h-8" viewBox="0 0 24 24"><path d="M15.75 19.5L8.25 12l7.5-7.5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
          </button>
          <button (click)="nextImage();$event.stopPropagation()" class="absolute top-1/2 right-2 md:right-4 -translate-y-1/2 bg-white/10 hover:bg-white/30 text-white rounded-full p-3 backdrop-blur-sm z-50">
            <svg class="w-8 h-8" viewBox="0 0 24 24"><path d="M8.25 4.5l7.5 7.5-7.5 7.5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
          </button>

          <div class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/60 text-white text-sm px-4 py-1 rounded-full backdrop-blur-sm">
            {{ currentIndex() + 1 }} / {{ product.images.length }}
          </div>
        }
      </div>
    </div>
  }

  <!-- SECCI√ìN TE PODR√çA INTERESAR (CROSS-SELLING) -->
  @if ((product.interestedItems?.length ?? 0) > 0) {
    <div class="mt-16 border-t border-gray-200 pt-10 pb-10">
      <h3 class="text-2xl font-bold text-gray-900 mb-2 flex items-center">
        Te podr√≠a interesar
      </h3>
      <p class="text-sm text-gray-500 mb-6">Explora productos relacionados con esta b√∫squeda.</p>

      <!-- Contenedor Scroll Horizontal -->
      <div class="flex overflow-x-auto gap-4 pb-4 snap-x scrollbar-hide">
        @for (item of product.interestedItems; track $index) {
          <div
            (click)="executeInterestSearch(item.searchKeyword)"
            class="snap-center shrink-0 w-36 sm:w-48 cursor-pointer group relative rounded-xl overflow-hidden border border-gray-200 shadow-sm hover:shadow-lg hover:border-blue-400 transition-all duration-300 active:scale-95 bg-white">

            <!-- Imagen Miniatura -->
            <div class="aspect-[1/1] w-full bg-gray-50 relative overflow-hidden">
              <img [src]="item.imageUrl"
                   alt="{{ item.searchKeyword }}"
                   class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">

              <!-- Overlay al hacer hover -->
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors flex items-center justify-center">
                 <span class="opacity-0 group-hover:opacity-100 bg-white text-gray-800 text-xs font-bold px-2 py-1 rounded-full shadow transform translate-y-2 group-hover:translate-y-0 transition-all duration-300">
                   VER M√ÅS
                 </span>
              </div>
            </div>

            <!-- Etiqueta -->
            <div class="px-3 py-2 bg-white border-t border-gray-100">
              <p class="text-sm font-medium text-gray-700 truncate text-center capitalize">
                {{ item.searchKeyword }}
              </p>
            </div>
          </div>
        }
      </div>
    </div>
  }

} @else {
  <div class="flex flex-col items-center justify-center h-64">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mb-4"></div>
    <p class="text-gray-500">Cargando producto...</p>
  </div>
}
